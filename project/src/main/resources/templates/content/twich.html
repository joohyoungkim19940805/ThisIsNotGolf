<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>주폭도는 풀 수 있는 게임 ♥</title>
<link rel="icon" type="image/x-icon" th:href=@{images/favicon.ico}>
<link th:href="@{css/common.css}" rel="stylesheet" />
<style>
	span.chat_id:after {
    	content: " : ";
	}
</style>
<script type="text/javascript">
	window.onload = () => {
		chatContentArr = document.querySelector('#chat_message_content');
		
		const webSocket = new WebSocket('ws://localhost:8079/room/twich');
		webSocket.onopen = function () { //서버쪽이랑 연결된 순간 onopen 메서드 호출되고
		    //console.log('서버와 웹소켓 연결 성공!');
		};
	    webSocket.onmessage = function (event) { //서버쪽에서 메세지가 전달된 순간 onmessage가 실행된다.
	        let data = JSON.parse(event.data);
	        if(data.hasOwnProperty('chat')){
	        	chatContentTemplate(data.chat).then(chatElement=>messageViewLoder(chatElement))
	        								.then(chatWrapCount=>chatControl(chatWrapCount))
	        }
	    };
	}
	var chatContentTemplate = ({message, user})=>{
		return new Promise(resolve =>
					setTimeout(resolve(
										[Object.assign(document.createElement('span'), {className : 'chat_id', textContent : user}), 
										Object.assign(document.createElement('span'),{className : 'chat_message', textContent : message})]
										)),0);
	}
    function messageViewLoder(chatElement){
    	return new Promise(resolve =>{
	    	if(chatContentArr){
				let div = document.createElement('div');
				div.append(...chatElement);
				chatContentArr.append(div);
			}
			return setTimeout(resolve(chatContentArr.childElementCount), 0);
    	});
	}
    function chatControl(chatWrapCount){
    	if(chatWrapCount >= 200){
    		chatContentArr.removeChild(chatContentArr.firstElementChild);
    	}
    	chatContentArr.scrollTop = chatContentArr.scrollHeight;
    }
	
</script>
</head>
<body style="height: 100%; min-height: 100%;">
	<div style="background-image: url('images/jululu_background_image.png'); 
		background-repeat: no-repeat;
    	background-size: 100% 100%;position:absolute; top:0; bottom:0; right:0; left:0;">
		<div class="top_button_wrapper">
		
		</div>
		<div>
			<div id="chat_message_content" class="chat_content" style="width:500px; height:500px; 
				writing-mode: horizontal-tb;overflow-y: hidden; overflow-x: hidden;
				overflow-wrap: break-word;border: inset; border-color: darkviolet;">
		
			</div>
		</div>
		<div class="bottom_button_wrapper">
			<div class="top_show_hide_wrap">
				<button class="top_show_hide" type="button"></button>
			</div>
			<div class="top_button_list"></div>
		</div>
	</div>
</body>
</html>